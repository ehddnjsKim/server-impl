<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œíŒ</title>
</head>
<body>
<h1>ğŸ“‹ ê²Œì‹œíŒ</h1>

<form id="postForm">
    <input type="text" id="title" placeholder="ì œëª©" required><br>
    <textarea id="content" placeholder="ë‚´ìš©" required></textarea><br>
    <button type="submit">ê²Œì‹œê¸€ ì‘ì„±</button>
</form>

<hr>

<div id="postList"></div>

<!-- âœ… í˜ì´ì§• ë²„íŠ¼ ì˜ì—­ -->
<div id="pagination"></div>

<nav style="margin-bottom: 20px;">
    <a href="post.html">ğŸ  ê²Œì‹œê¸€</a> |
    <a href="mypage.html">ğŸ™‹ ë§ˆì´í˜ì´ì§€</a> |
    <a href="login.html" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
</nav>

<script>
    const size = 10; // í•œ í˜ì´ì§€ì— ë³´ì—¬ì¤„ ê²Œì‹œê¸€ ìˆ˜
    let currentPage = 1;
    let loginUserId = null;

    // ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadPosts(page = 1) {
        currentPage = page;

        fetch(`/api/posts?page=${page}&size=${size}`)
            .then(res => res.json())
            .then(posts => {
                console.log("ğŸ“¦ ë¶ˆëŸ¬ì˜¨ ê²Œì‹œê¸€:", posts);
                const listDiv = document.getElementById("postList");
                listDiv.innerHTML = "";

                if (posts.length === 0) {
                    listDiv.innerHTML = "<p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                posts.forEach(post => {
                    const rawDate = post.created_at;
                    const formattedDate = rawDate
                        ? rawDate.replace("T", " ").slice(0, 16)
                        : "ë‚ ì§œ ì—†ìŒ";

                    const postDiv = document.createElement("div");
                    postDiv.innerHTML = `
                        <h3><a href="post.html?id=${post.id}">${post.title}</a></h3>
                        <p>${post.content}</p>
                        <p><small>ì‘ì„±ì¼: ${formattedDate}</small></p>
                        <hr>
                    `;
                    listDiv.appendChild(postDiv);
                });
            })
            .catch(err => {
                console.error("âŒ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            });

        // ì „ì²´ ê¸€ ìˆ˜ë¡œ í˜ì´ì§€ ë²„íŠ¼
        fetch('/api/posts/count')
            .then(res => res.json())
            .then(totalCount => {
                const totalPages = Math.ceil(totalCount / size);
                const pagination = document.getElementById("pagination");
                pagination.innerHTML = "";

                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement("button");
                    btn.textContent = i;
                    btn.disabled = (i === page);
                    btn.onclick = () => loadPosts(i);
                    pagination.appendChild(btn);
                }
            });
    }

    // ê²Œì‹œê¸€ ì‘ì„±
    document.getElementById("postForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const newPost = {
            title: document.getElementById("title").value,
            content: document.getElementById("content").value
        };

        fetch("/api/posts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newPost)
        })
            .then(res => {
                if (res.ok) {
                    alert("ê²Œì‹œê¸€ ì‘ì„± ì„±ê³µ");
                    loadPosts(1); // ì²« í˜ì´ì§€ ë‹¤ì‹œ ë¡œë”©
                    document.getElementById("postForm").reset();
                } else {
                    return res.text().then(text => { throw new Error(text); });
                }
            })
            .catch(err => alert("ì‘ì„± ì‹¤íŒ¨: " + err.message));
    });

    // ê²Œì‹œê¸€ ì‚­ì œ (í•„ìš” ì‹œ í™œì„±í™”)
    function deletePost(id) {
        fetch(`/api/posts/${id}`, {
            method: "DELETE"
        })
            .then(res => {
                if (res.ok) {
                    alert("ì‚­ì œ ì„±ê³µ");
                    loadPosts(currentPage);
                } else {
                    return res.text().then(text => { throw new Error(text); });
                }
            })
            .catch(err => alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message));
    }

    // ë¡œê·¸ì¸ëœ ìœ ì € ì •ë³´ í™•ì¸
    fetch('/api/users/session')
        .then(res => {
            if (res.ok) return res.json();
            else throw new Error("ë¡œê·¸ì¸ ì•ˆë¨");
        })
        .then(user => {
            loginUserId = user.id; // âœ… ë‚´ ê¸€ íŒë‹¨ìš©
            loadPosts();
        })
        .catch(() => {
            loadPosts(); // ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ë„ ëª©ë¡ì€ í‘œì‹œ
        });

    // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ (ë²„íŠ¼ í´ë¦­ ì‹œ)
    function logout() {
        fetch('/api/users/logout', { method: 'POST' })
            .then(() => {
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');
                location.href = 'login.html';
            });
    }
</script>
</body>
</html>
