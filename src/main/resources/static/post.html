<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <style>
        #buttonWrapper {
            margin-top: 10px;
            text-align: right;
        }
        #buttonWrapper button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
<h1>ğŸ“ ê²Œì‹œê¸€ ìƒì„¸</h1>

<div id="postDetail"></div>

<hr>

<div id="editSection" style="display: none;">
    <h3>ìˆ˜ì •í•˜ê¸°</h3>
    <form id="editForm">
        <input type="text" id="editTitle" required><br>
        <textarea id="editContent" required></textarea><br>
        <button type="submit">ìˆ˜ì •</button>
    </form>
</div>

<p><a href="index.html">â† ê²Œì‹œíŒ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a></p>

<script>
    const params = new URLSearchParams(location.search);
    const postId = params.get("id");
    const loginUserId = sessionStorage.getItem("loginUserId");

    let postData = null;

    fetch(`/api/posts/${postId}`)
        .then(res => {
            if (!res.ok) throw new Error("ê²Œì‹œê¸€ ì¡°íšŒ ì‹¤íŒ¨");
            return res.json();
        })
        .then(post => {
            postData = post;

            const formattedDate = post.created_at
                ? post.created_at.replace("T", " ").slice(0, 16)
                : "ë‚ ì§œ ì—†ìŒ";

            // ê¸°ë³¸ ì¶œë ¥ ë‚´ìš©
            let html = `
                <h2>${post.title}</h2>
                <p>${post.content}</p>
                <p><small>ì‘ì„±ì¼: ${formattedDate}</small></p>
            `;

            // âœ… user_idë¡œ ë¹„êµ (snake_case ì‘ë‹µ ëŒ€ì‘)
            if (loginUserId == post.user_id) {
                html += `
                    <div id="buttonWrapper">
                        <button onclick="toggleEdit()">âœï¸ ìˆ˜ì •</button>
                        <button onclick="confirmDelete()">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                `;

                // ìˆ˜ì •í¼ ì´ˆê¸° ì„¸íŒ…
                document.getElementById("editTitle").value = post.title;
                document.getElementById("editContent").value = post.content;
            }

            document.getElementById("postDetail").innerHTML = html;
        })
        .catch(err => {
            alert("ê²Œì‹œê¸€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            console.error(err);
        });

    // ìˆ˜ì • í¼ í† ê¸€
    function toggleEdit() {
        const section = document.getElementById("editSection");
        section.style.display = section.style.display === "none" ? "block" : "none";
    }

    // ìˆ˜ì • ìš”ì²­
    document.getElementById("editForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const updatedPost = {
            title: document.getElementById("editTitle").value,
            content: document.getElementById("editContent").value
        };

        fetch(`/api/posts/${postId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedPost)
        })
            .then(res => {
                if (res.ok) {
                    alert("ìˆ˜ì • ì™„ë£Œ");
                    location.reload();
                } else {
                    return res.text().then(text => { throw new Error(text); });
                }
            })
            .catch(err => alert("ìˆ˜ì • ì‹¤íŒ¨: " + err.message));
    });

    // ì‚­ì œ ìš”ì²­
    function confirmDelete() {
        if (!confirm("ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/api/posts/${postId}`, {
            method: "DELETE"
        })
            .then(res => {
                if (res.ok) {
                    alert("ì‚­ì œ ì™„ë£Œ");
                    window.location.href = "index.html";
                } else {
                    return res.text().then(text => { throw new Error(text); });
                }
            })
            .catch(err => alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message));
    }
</script>
</body>
</html>
